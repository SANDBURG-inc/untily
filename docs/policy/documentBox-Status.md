# DocumentBox 상태 관리 정책

> 문서함 상태(Status)의 정의, 분류, 전환 규칙

---

## 1. 상태 정의

| 상태 | 코드 | 설명 | 제출 가능 여부 |
|------|------|------|---------------|
| **열림** | `OPEN` | 정상 운영 중 (기본값) | ✅ 모두 가능 |
| **닫힘** | `CLOSED` | 관리자가 수동으로 닫음 또는 소유자 탈퇴 | ❌ 불가 |
| **일부열림** | `OPEN_SOMEONE` | 마감 후 리마인드 수신자만 제출 가능 | ⚠️ 일부만 가능 |
| **자동닫힘** | `CLOSED_EXPIRED` | 마감일 경과로 자동 닫힘 | ❌ 불가 |
| **다시열림** | `OPEN_RESUME` | 관리자가 닫힌 문서함을 다시 열음 | ✅ 모두 가능 |

---

## 2. 상태 분류

### 2.1 제출 가능 여부 기준

```
┌─────────────────────────────────────────────────────────┐
│                    제출 가능 상태                        │
│  ┌─────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  OPEN   │  │ OPEN_RESUME │  │ OPEN_SOMEONE (일부) │  │
│  └─────────┘  └─────────────┘  └─────────────────────┘  │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                    제출 불가 상태                        │
│  ┌─────────┐  ┌─────────────────┐                       │
│  │ CLOSED  │  │ CLOSED_EXPIRED  │                       │
│  └─────────┘  └─────────────────┘                       │
└─────────────────────────────────────────────────────────┘
```

### 2.2 전환 주체 기준

| 분류 | 상태 | 전환 주체 |
|------|------|----------|
| **자동 전환** | `CLOSED_EXPIRED` | Cron Job (시스템) |
| **자동 전환** | `CLOSED` | 회원 탈퇴 시 (시스템) |
| **수동 전환** | `CLOSED` | 관리자 (대시보드) |
| **수동 전환** | `OPEN_RESUME` | 관리자 (대시보드, 수정 폼) |
| **조건부 전환** | `OPEN_SOMEONE` | 관리자 (보내기 페이지) |
| **기본값** | `OPEN` | 문서함 생성 시 |

### 2.3 마감일 기준

| 분류 | 상태 | 설명 |
|------|------|------|
| **마감 전 상태** | `OPEN` | 일반적인 운영 상태 |
| **마감 후 특수 상태** | `OPEN_SOMEONE` | 마감 후 리마인드 발송으로 전환 |
| **마감 후 특수 상태** | `OPEN_RESUME` | 마감 후 관리자가 다시 열기 |
| **마감 후 기본 상태** | `CLOSED_EXPIRED` | 마감일 경과 시 자동 전환 |
| **마감 무관** | `CLOSED` | 수동 닫기, 소유자 탈퇴 |

---

## 3. 상태 전환 다이어그램

```
                              ┌──────────────┐
                              │   (생성)     │
                              └──────┬───────┘
                                     │
                                     ▼
                              ┌──────────────┐
           ┌─────────────────▶│     OPEN     │◀─────────────────┐
           │                  └──────┬───────┘                  │
           │                         │                          │
           │         ┌───────────────┼───────────────┐          │
           │         │               │               │          │
           │         ▼               ▼               ▼          │
           │  [대시보드 닫기]  [마감일 경과]   [소유자 탈퇴]      │
           │         │               │               │          │
           │         ▼               ▼               ▼          │
           │  ┌──────────┐   ┌──────────────┐  ┌──────────┐     │
           │  │  CLOSED  │   │CLOSED_EXPIRED│  │  CLOSED  │     │
           │  └────┬─────┘   └──────┬───────┘  └──────────┘     │
           │       │                │                           │
           │       │    ┌───────────┴───────────┐               │
           │       │    │                       │               │
           │       ▼    ▼                       ▼               │
           │  [대시보드 열기]           [마감 후 리마인드 발송]   │
           │       │                            │               │
           │       ▼                            ▼               │
           │  ┌──────────────┐          ┌──────────────┐        │
           │  │ OPEN_RESUME  │          │ OPEN_SOMEONE │        │
           │  └──────┬───────┘          └──────┬───────┘        │
           │         │                         │                │
           │         │    [대시보드 닫기]       │                │
           │         │          │              │                │
           │         ▼          ▼              ▼                │
           │         └──────▶ CLOSED ◀─────────┘                │
           │                                                    │
           │         [수정 폼에서 기한 연장 + 확인]               │
           └────────────────────────────────────────────────────┘
```

---

## 4. 전환 규칙 상세

### 4.1 OPEN (열림)

**진입 조건:**
| 트리거 | 이전 상태 | UI/API |
|--------|----------|--------|
| 문서함 생성 | - | `/dashboard/register` |
| 기한 연장 확인 | `CLOSED`, `CLOSED_EXPIRED`, `OPEN_SOMEONE` | `/dashboard/[id]/edit` |

**탈출 조건:**
| 트리거 | 다음 상태 | UI/API |
|--------|----------|--------|
| 대시보드에서 "닫힘으로 변경" | `CLOSED` | `/dashboard` (드롭다운) |
| 마감일 경과 (Cron Job) | `CLOSED_EXPIRED` | `/api/cron/status-transition` |
| 소유자 회원 탈퇴 | `CLOSED` | `/api/user/delete` |

---

### 4.2 CLOSED (닫힘)

**진입 조건:**
| 트리거 | 이전 상태 | UI/API |
|--------|----------|--------|
| 대시보드에서 "닫힘으로 변경" | `OPEN`, `OPEN_SOMEONE`, `OPEN_RESUME` | `/dashboard` (드롭다운) |
| 소유자 회원 탈퇴 | 모든 상태 | `/api/user/delete` |

**탈출 조건:**
| 트리거 | 다음 상태 | UI/API |
|--------|----------|--------|
| 대시보드에서 "열림으로 변경" | `OPEN_RESUME` | `/dashboard` (드롭다운) |
| 수정 폼에서 기한 연장 + 확인 | `OPEN` | `/dashboard/[id]/edit` |
| 보내기 페이지에서 리마인드 발송 | `OPEN_SOMEONE` | `/dashboard/[id]/send` |

---

### 4.3 OPEN_SOMEONE (일부열림)

**진입 조건:**
| 트리거 | 이전 상태 | UI/API |
|--------|----------|--------|
| 마감 후 리마인드 발송 + 확인 | `OPEN` 외 모든 상태 | `/dashboard/[id]/send` (Dialog 확인) |

**제출 권한:**
- ✅ 해당 리마인드를 받은 제출자만 제출 가능
- ❌ 리마인드를 받지 않은 제출자는 `/submit/closed`로 리다이렉트

**탈출 조건:**
| 트리거 | 다음 상태 | UI/API |
|--------|----------|--------|
| 대시보드에서 "닫힘으로 변경" | `CLOSED` | `/dashboard` (드롭다운) |
| 수정 폼에서 기한 연장 + 확인 | `OPEN` | `/dashboard/[id]/edit` |

---

### 4.4 CLOSED_EXPIRED (자동닫힘)

**진입 조건:**
| 트리거 | 이전 상태 | UI/API |
|--------|----------|--------|
| 마감일 경과 (Cron Job) | `OPEN` | `/api/cron/status-transition` |

**특징:**
- 시스템에 의해 자동으로 전환됨
- 30분마다 Cron Job 실행 시 마감일이 지난 `OPEN` 상태 문서함 대상
- `OPEN_SOMEONE`, `OPEN_RESUME`는 자동 전환 대상에서 제외

**탈출 조건:**
| 트리거 | 다음 상태 | UI/API |
|--------|----------|--------|
| 대시보드에서 "열림으로 변경" | `OPEN_RESUME` | `/dashboard` (드롭다운) |
| 수정 폼에서 기한 연장 + 확인 | `OPEN` | `/dashboard/[id]/edit` |
| 보내기 페이지에서 리마인드 발송 | `OPEN_SOMEONE` | `/dashboard/[id]/send` |

---

### 4.5 OPEN_RESUME (다시열림)

**진입 조건:**
| 트리거 | 이전 상태 | UI/API |
|--------|----------|--------|
| 대시보드에서 "열림으로 변경" | `CLOSED`, `CLOSED_EXPIRED` | `/dashboard` (드롭다운) |

**특징:**
- 마감일이 지났어도 모든 사용자가 제출 가능
- Cron Job에 의해 자동으로 닫히지 않음 (특수 상태 보호)

**탈출 조건:**
| 트리거 | 다음 상태 | UI/API |
|--------|----------|--------|
| 대시보드에서 "닫힘으로 변경" | `CLOSED` | `/dashboard` (드롭다운) |

---

## 5. UI별 상태 전환 요약

### 5.1 대시보드 (`/dashboard`)

**StatusChangeDropdown 컴포넌트**

| 현재 상태 | 표시되는 옵션 | 클릭 시 전환 |
|----------|-------------|-------------|
| `OPEN` | "닫힘으로 변경" | → `CLOSED` |
| `OPEN_SOMEONE` | "닫힘으로 변경" | → `CLOSED` |
| `OPEN_RESUME` | "닫힘으로 변경" | → `CLOSED` |
| `CLOSED` | "열림으로 변경" | → `OPEN_RESUME` |
| `CLOSED_EXPIRED` | "열림으로 변경" | → `OPEN_RESUME` |

---

### 5.2 문서함 수정 (`/dashboard/[id]/edit`)

**SubmissionSettingsCard - 기한 변경 시**

| 현재 상태 | 기한 변경 동작 | 확인 후 전환 |
|----------|---------------|-------------|
| `OPEN` + 과거 날짜 설정 | "기한 만료 경고" Dialog | Cron에 의해 → `CLOSED_EXPIRED` |
| `OPEN` + 미래 날짜 설정 | Dialog 없음 | 변경 없음 |
| `OPEN_RESUME` | Dialog 없음 | 변경 없음 |
| `OPEN_SOMEONE` | Dialog 없음 | 변경 없음 |
| `CLOSED` + 미래 날짜 연장 | "다시 열기" Dialog | → `OPEN` |
| `CLOSED_EXPIRED` + 미래 날짜 연장 | "다시 열기" Dialog | → `OPEN` |

> ⚠️ **주의사항**:
> - "다시 열기" Dialog는 **미래 날짜로 연장**할 때만 표시됨 (과거→과거 연장은 Dialog 없음)
> - `OPEN_SOMEONE`, `OPEN_RESUME`는 Cron 보호 상태이므로 과거 날짜 설정 시 경고 Dialog 없음

---

### 5.3 보내기 페이지 (`/dashboard/[id]/send`)

**SendForm - 리마인드 발송 시**

| 현재 상태 | 발송 버튼 클릭 시 | 확인 후 전환 |
|----------|-----------------|-------------|
| `OPEN` | 바로 발송 | 변경 없음 |
| `OPEN_RESUME` | 바로 발송 | 변경 없음 |
| `CLOSED` | "마감 후 발송" Dialog | → `OPEN_SOMEONE` |
| `CLOSED_EXPIRED` | "마감 후 발송" Dialog | → `OPEN_SOMEONE` |
| `OPEN_SOMEONE` | "마감 후 발송" Dialog | 변경 없음 (유지) |

> ⚠️ **중요**: `OPEN_RESUME`는 이미 모든 사용자가 제출 가능한 상태이므로 Dialog 없이 바로 발송.
> Dialog를 통해 `OPEN_SOMEONE`으로 변경되면 오히려 제출 권한이 축소되므로 주의.

---

### 5.4 Cron Job (`/api/cron/status-transition`)

**자동 상태 전환 (30분마다)**

| 조건 | 전환 |
|------|------|
| `OPEN` + 마감일 경과 | → `CLOSED_EXPIRED` |
| `OPEN_SOMEONE` + 마감일 경과 | 변경 없음 (보호) |
| `OPEN_RESUME` + 마감일 경과 | 변경 없음 (보호) |

---

### 5.5 회원 탈퇴 (`/api/user/delete`)

**소유자 탈퇴 시**

| 조건 | 전환 |
|------|------|
| 모든 상태 | → `CLOSED` |

---

## 6. 제출자 접근 권한 정리

| 상태 | 공개 제출 | 지정 제출자 | 리마인드 수신자 |
|------|----------|-----------|---------------|
| `OPEN` | ✅ | ✅ | ✅ |
| `OPEN_RESUME` | ✅ | ✅ | ✅ |
| `OPEN_SOMEONE` | ❌ | ❌ | ✅ |
| `CLOSED` | ❌ | ❌ | ❌ |
| `CLOSED_EXPIRED` | ❌ | ❌ | ❌ |

---

## 7. 엣지 케이스 및 주의사항

### 7.1 상태별 제출 권한 축소 주의

```
OPEN_RESUME (모두 가능) → OPEN_SOMEONE (일부만 가능)
```

`OPEN_RESUME` 상태에서 리마인드 발송 Dialog를 통해 `OPEN_SOMEONE`으로 변경하면 제출 권한이 **축소**됨.
따라서 `OPEN_RESUME`에서는 Dialog 없이 바로 발송하도록 구현됨.

### 7.2 OPEN_RESUME에서 기한 연장

| 상태 | 기한 연장 시 | 이유 |
|------|------------|------|
| `OPEN_RESUME` | 상태 유지 | 이미 "열린" 상태이므로 Dialog 불필요 |

- `OPEN_RESUME`는 관리자가 의도적으로 다시 연 상태
- 기한을 연장해도 "다시열림" 의미는 유효
- 굳이 `OPEN`으로 전환하지 않음

### 7.3 회원 탈퇴 후 문서함

| 상황 | 결과 |
|------|------|
| 소유자 탈퇴 | 상태 → `CLOSED`, userId → `DELETED_USER_xxx` |

- 탈퇴 후 해당 문서함은 관리자가 접근 불가 (실질적 Trap State)
- 제출자는 `/submit/closed` 페이지로 리다이렉트
- 이미 제출된 파일은 S3에 보관됨 (삭제되지 않음)

### 7.4 Cron Job 보호 상태

Cron Job은 `OPEN` → `CLOSED_EXPIRED`만 자동 전환:

| 상태 | Cron Job 대상 | 이유 |
|------|-------------|------|
| `OPEN` | ✅ 대상 | 일반적인 마감 처리 |
| `OPEN_SOMEONE` | ❌ 보호 | 관리자가 마감 후 리마인드 발송한 상태 |
| `OPEN_RESUME` | ❌ 보호 | 관리자가 의도적으로 다시 연 상태 |

---

## 8. 관련 코드 참조

| 분류 | 파일 | 함수/컴포넌트 |
|------|------|-------------|
| 타입 정의 | `lib/types/document.ts` | `DocumentBoxStatus`, `isDocumentBoxOpen()` |
| 상태 변경 | `app/dashboard/[id]/actions.ts` | `updateDocumentBoxStatus()` |
| 드롭다운 UI | `components/dashboard/StatusChangeDropdown.tsx` | `StatusChangeDropdown` |
| 인증 체크 | `lib/auth/submitter-auth.ts` | `validateSubmitterAuth()` |
| 리마인드 확인 | `lib/queries/reminder.ts` | `hasReceivedReminderAfterDeadline()` |
| Cron Job | `app/api/cron/status-transition/route.ts` | `GET()` |
