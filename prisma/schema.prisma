// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Logo {
  logoId    String   @id @default(cuid())
  imageUrl  String
  createdAt DateTime @default(now())
  userId    String   @unique

  @@index([userId])
}

model DocumentBox {
  documentBoxId  String   @id @default(cuid())
  boxTitle       String
  boxDescription String?
  createdAt      DateTime @default(now())
  endDate        DateTime
  userId         String

  submitters             Submitter[]
  requiredDocuments      RequiredDocument[]
  documentBoxRemindTypes DocumentBoxRemindType[]
  reminderLogs           ReminderLog[]

  @@index([userId])
}

model RequiredDocument {
  requiredDocumentId  String      @id @default(cuid())
  documentTitle       String
  documentDescription String?
  isRequired          Boolean     @default(true)
  documentBoxId       String
  documentBox         DocumentBox @relation(fields: [documentBoxId], references: [documentBoxId])

  submittedDocuments SubmittedDocument[]
}

model Submitter {
  submitterId   String          @id @default(cuid())
  name          String
  email         String
  phone         String
  documentBoxId String
  documentBox   DocumentBox     @relation(fields: [documentBoxId], references: [documentBoxId])

  // 제출자 인증 관련 필드
  userId        String?         // Stack Auth 사용자 ID (로그인 시 연결)
  status        SubmitterStatus @default(PENDING)
  submittedAt   DateTime?       // 제출 완료 시간

  submittedDocuments SubmittedDocument[]
  reminderRecipients ReminderRecipient[]

  @@index([userId])
  @@index([email])
}

model SubmittedDocument {
  submittedDocumentId String           @id @default(cuid())

  // S3 관련 필드
  s3Key               String
  filename            String
  size                Int
  mimeType            String

  // 기존 필드
  fileUrl             String
  createdAt           DateTime         @default(now())

  // 관계 필드
  requiredDocumentId  String
  requiredDocument    RequiredDocument @relation(fields: [requiredDocumentId], references: [requiredDocumentId])
  submitterId         String
  submitter           Submitter        @relation(fields: [submitterId], references: [submitterId])

  @@index([submitterId])
  @@index([requiredDocumentId])
}

model DocumentBoxRemindType {
  documentBoxId String
  remindType    RemindType
  documentBox   DocumentBox @relation(fields: [documentBoxId], references: [documentBoxId])

  @@id([documentBoxId, remindType])
}

enum RemindType {
  EMAIL
  SMS
  PUSH
}

enum SubmitterStatus {
  PENDING
  SUBMITTED
}

model ReminderLog {
  id            String              @id @default(cuid())
  documentBoxId String
  documentBox   DocumentBox         @relation(fields: [documentBoxId], references: [documentBoxId])
  sentAt        DateTime            @default(now())
  channel       RemindType
  isAuto        Boolean // true: 자동, false: 수동
  recipients    ReminderRecipient[]
}

model ReminderRecipient {
  id            String      @id @default(cuid())
  reminderLogId String
  reminderLog   ReminderLog @relation(fields: [reminderLogId], references: [id])
  submitterId   String
  submitter     Submitter   @relation(fields: [submitterId], references: [submitterId])

  @@index([reminderLogId])
  @@index([submitterId])
}
