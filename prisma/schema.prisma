// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Logo {
  logoId    String   @id @default(cuid())
  imageUrl  String
  createdAt DateTime @default(now())
  userId    String   @unique

  @@index([userId])
}

model DocumentBox {
  documentBoxId  String   @id @default(cuid())
  boxTitle       String
  boxDescription String?
  createdAt      DateTime @default(now())
  endDate        DateTime
  userId         String

  // 제출자 지정 여부 플래그
  // - true: 지정 제출자가 있는 문서함 (예: 연말정산, 신청서)
  // - false: 지정 제출자가 없는 문서함 (예: 설문조사, 공개 수집)
  // [후방호환성] 기존 데이터는 null이며, null인 경우 true로 취급
  // 관련 유틸: lib/utils/document-box.ts > hasDesignatedSubmitters()
  hasSubmitter Boolean?

  submitters             Submitter[]
  requiredDocuments      RequiredDocument[]
  documentBoxRemindTypes DocumentBoxRemindType[]
  reminderLogs           ReminderLog[]

  @@index([userId])
}

model RequiredDocument {
  requiredDocumentId  String      @id @default(cuid())
  documentTitle       String
  documentDescription String?
  isRequired          Boolean     @default(true)
  documentBoxId       String
  documentBox         DocumentBox @relation(fields: [documentBoxId], references: [documentBoxId])

  submittedDocuments SubmittedDocument[]
}

model Submitter {
  submitterId   String      @id @default(cuid())
  name          String
  email         String
  phone         String
  documentBoxId String
  documentBox   DocumentBox @relation(fields: [documentBoxId], references: [documentBoxId])

  submittedDocuments SubmittedDocument[]
  reminderRecipients ReminderRecipient[]
}

model SubmittedDocument {
  submittedDocumentId String           @id @default(cuid())
  fileUrl             String
  createdAt           DateTime         @default(now())
  requiredDocumentId  String
  requiredDocument    RequiredDocument @relation(fields: [requiredDocumentId], references: [requiredDocumentId])
  submitterId         String
  submitter           Submitter        @relation(fields: [submitterId], references: [submitterId])
}

model DocumentBoxRemindType {
  documentBoxId String
  remindType    RemindType
  documentBox   DocumentBox @relation(fields: [documentBoxId], references: [documentBoxId])

  @@id([documentBoxId, remindType])
}

enum RemindType {
  EMAIL
  SMS
  PUSH
}

model ReminderLog {
  id            String              @id @default(cuid())
  documentBoxId String
  documentBox   DocumentBox         @relation(fields: [documentBoxId], references: [documentBoxId])
  sentAt        DateTime            @default(now())
  channel       RemindType
  isAuto        Boolean // true: 자동, false: 수동
  recipients    ReminderRecipient[]
}

model ReminderRecipient {
  id            String      @id @default(cuid())
  reminderLogId String
  reminderLog   ReminderLog @relation(fields: [reminderLogId], references: [id])
  submitterId   String
  submitter     Submitter   @relation(fields: [submitterId], references: [submitterId])

  @@index([reminderLogId])
  @@index([submitterId])
}
