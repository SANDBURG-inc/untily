// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model Logo {
  logoId    String   @id @default(cuid())
  imageUrl  String
  createdAt DateTime @default(now())
  userId    String
  type      LogoType @default(DEFAULT)

  // 문서함 로고인 경우에만 사용 (type이 DOCUMENT_BOX일 때)
  documentBoxId String?
  documentBox   DocumentBox? @relation(fields: [documentBoxId], references: [documentBoxId])

  @@unique([userId, type, documentBoxId])
  @@index([userId])
  @@index([documentBoxId])
}

enum LogoType {
  DEFAULT // 사용자 기본 로고
  DOCUMENT_BOX // 문서함별 로고
}

// 문서함 상태
// - OPEN: 제출 가능 (기본값, 마감 전)
// - CLOSED: 제출 불가 (소유자 탈퇴, 수동 닫기)
// - OPEN_SOMEONE: 마감 후 제한적 오픈 (마감 후 리마인드 수신자만 제출 가능)
// - CLOSED_EXPIRED: 마감 후 기본 상태 (완전 닫힘)
// - OPEN_RESUME: 마감 후 관리자가 다시 연 상태 (자동으로 닫히지 않음)
enum DocumentBoxStatus {
  OPEN
  CLOSED
  OPEN_SOMEONE
  CLOSED_EXPIRED
  OPEN_RESUME
}

model DocumentBox {
  documentBoxId  String   @id @default(cuid())
  boxTitle       String
  boxDescription String?
  createdAt      DateTime @default(now())
  endDate        DateTime
  userId         String

  // 제출자 지정 여부 플래그
  // - true: 지정 제출자가 있는 문서함 (예: 연말정산, 신청서)
  // - false: 지정 제출자가 없는 문서함 (예: 설문조사, 공개 수집)
  // [후방호환성] 기존 데이터는 null이며, null인 경우 true로 취급
  // 관련 유틸: lib/utils/document-box.ts > hasDesignatedSubmitters()
  hasSubmitter Boolean?

  // 문서함 상태
  // - OPEN: 제출 가능 (기본값)
  // - CLOSED: 제출 불가 (소유자 탈퇴, 수동 닫기)
  status DocumentBoxStatus @default(OPEN)

  // 폼 필드 표시 위치 설정
  // - true: 수집 서류 위에 표시 (개인정보 동의 먼저)
  // - false: 수집 서류 아래에 표시 (기본값)
  formFieldsAboveDocuments Boolean @default(false)

  logos                  Logo[]
  submitters             Submitter[]
  requiredDocuments      RequiredDocument[]
  formFields             FormField[]
  documentBoxRemindTypes DocumentBoxRemindType[]
  reminderLogs           ReminderLog[]
  reminderSchedules      ReminderSchedule[]
  templateConfigs        DocumentBoxTemplateConfig[]

  @@index([userId])
}

model RequiredDocument {
  requiredDocumentId  String      @id @default(cuid())
  documentTitle       String
  documentDescription String?
  isRequired          Boolean     @default(true)
  allowMultipleFiles  Boolean     @default(false)
  order               Int         @default(0) // 표시 순서
  documentBoxId       String
  documentBox         DocumentBox @relation(fields: [documentBoxId], references: [documentBoxId])

  // 양식 파일 목록 (JSON 배열)
  // 형식: [{s3Key: string, filename: string}, ...]
  templates Json? @default("[]")

  // 양식 파일 ZIP (2개 이상일 때 미리 생성)
  // S3 경로: templates/{documentBoxId}_zip/{requiredDocumentId}.zip
  templateZipKey String?

  submittedDocuments SubmittedDocument[]
}

model Submitter {
  submitterId   String      @id @default(cuid())
  name          String
  email         String
  phone         String
  documentBoxId String
  documentBox   DocumentBox @relation(fields: [documentBoxId], references: [documentBoxId])

  // 제출자 인증 관련 필드
  userId      String? // Stack Auth 사용자 ID (로그인 시 연결)
  status      SubmitterStatus @default(PENDING)
  submittedAt DateTime? // 제출 완료 시간

  submittedDocuments SubmittedDocument[]
  formFieldResponses FormFieldResponse[]
  reminderRecipients ReminderRecipient[]

  @@index([userId])
  @@index([email])
}

model SubmittedDocument {
  submittedDocumentId String @id @default(cuid())

  // S3 관련 필드
  s3Key            String
  filename         String // 관리자용 가공 파일명 (서류명_날짜_제출자명.확장자)
  originalFilename String // 원본 파일명 (사용자가 업로드한 파일명)
  size             Int
  mimeType         String

  // 기존 필드
  fileUrl   String
  createdAt DateTime @default(now())

  // 관계 필드
  requiredDocumentId String
  requiredDocument   RequiredDocument @relation(fields: [requiredDocumentId], references: [requiredDocumentId])
  submitterId        String
  submitter          Submitter        @relation(fields: [submitterId], references: [submitterId])

  @@index([submitterId])
  @@index([requiredDocumentId])
}

model DocumentBoxRemindType {
  documentBoxId String
  remindType    RemindType
  documentBox   DocumentBox @relation(fields: [documentBoxId], references: [documentBoxId])

  @@id([documentBoxId, remindType])
}

enum RemindType {
  EMAIL
  SMS
  PUSH
}

// ============================================================================
// 사용자 구독 관리
// ============================================================================

enum SubscriptionPlan {
  FREE  // 무료
  BETA  // 베타 기간 무료
  BASIC // 기본 플랜
  PRO   // 프로 플랜
}

model User {
  userId           String           @id @default(cuid())
  authUserId       String           @unique // Neon Auth user.id
  subscriptionPlan SubscriptionPlan @default(BETA)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  @@index([authUserId])
}

// ============================================================================
// 리마인더 스케줄
// ============================================================================

enum ReminderTimeUnit {
  DAY  // n일 전
  WEEK // n주 전
}

model ReminderSchedule {
  id            String           @id @default(cuid())
  documentBoxId String
  documentBox   DocumentBox      @relation(fields: [documentBoxId], references: [documentBoxId], onDelete: Cascade)

  // 발송 시점 설정
  timeValue Int              // 숫자 값 (1, 2, 3...)
  timeUnit  ReminderTimeUnit // DAY 또는 WEEK
  sendTime  String           // HH:mm 형식 (예: "09:00", "14:30")

  // 채널 설정
  channel RemindType @default(EMAIL)

  // 템플릿 설정 (null이면 문서함 기본 템플릿 사용)
  templateId   String?        // 저장된 RemindTemplate ID (참조용)
  greetingHtml String? @db.Text // 인사말 HTML (스냅샷)
  footerHtml   String? @db.Text // 아랫말 HTML (스냅샷)

  // 순서 (UI 표시 및 관리용)
  order Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([documentBoxId])
  @@index([sendTime])
}

enum SubmitterStatus {
  PENDING
  SUBMITTED
}

// ============================================================================
// 폼 필드 (정보 입력 항목)
// ============================================================================

enum FormFieldType {
  TEXT      // 단답형 텍스트
  TEXTAREA  // 장문형 텍스트
  EMAIL     // 이메일 (validation 포함)
  TEL       // 전화번호 (validation 포함)
  DATE      // 날짜 선택
  TIME      // 시간 선택
  CHECKBOX  // 체크박스 (복수 선택)
  RADIO     // 객관식 (1개 선택)
  DROPDOWN  // 드롭다운 (1개 선택)
}

// 폼 필드 정의 (개별 질문 - 구글 폼 스타일)
// 그룹 없이 DocumentBox에 직접 연결
model FormField {
  formFieldId String        @id @default(cuid())
  fieldLabel  String        // 질문 텍스트
  fieldType   FormFieldType // 질문 타입
  placeholder String?       // 플레이스홀더 텍스트
  description String?       // 질문 설명 (선택적)
  isRequired  Boolean       @default(true) // 필수 여부
  order       Int           @default(0) // 표시 순서

  // 선택지 (JSON 배열) - RADIO, CHECKBOX, DROPDOWN에서 사용
  // 형식: ["옵션1", "옵션2", "옵션3"]
  options Json? @default("[]")

  // '기타' 옵션 활성화 여부 (RADIO, CHECKBOX에서만 사용)
  hasOtherOption Boolean @default(false)

  // 유효성 검사 규칙 (JSON, 확장용)
  // 형식: {minLength: 1, maxLength: 100}
  validation Json?

  // DocumentBox에 직접 연결 (FormFieldGroup 제거)
  documentBoxId String
  documentBox   DocumentBox @relation(fields: [documentBoxId], references: [documentBoxId], onDelete: Cascade)

  responses FormFieldResponse[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([documentBoxId])
}

// 폼 응답 (제출자가 입력)
model FormFieldResponse {
  formFieldResponseId String @id @default(cuid())
  value               String // 응답 값 (string으로 통일)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  formFieldId String
  formField   FormField @relation(fields: [formFieldId], references: [formFieldId], onDelete: Cascade)

  submitterId String
  submitter   Submitter @relation(fields: [submitterId], references: [submitterId], onDelete: Cascade)

  @@unique([formFieldId, submitterId]) // 제출자당 필드별 1개 응답
  @@index([submitterId])
  @@index([formFieldId])
}

model ReminderLog {
  id            String              @id @default(cuid())
  documentBoxId String
  documentBox   DocumentBox         @relation(fields: [documentBoxId], references: [documentBoxId])
  sentAt        DateTime            @default(now())
  channel       RemindType
  isAuto        Boolean // true: 자동, false: 수동

  // 마감 후 발송 여부 (OPEN_SOMEONE 상태에서 제출 허용 판단에 사용)
  sentAfterDeadline Boolean @default(false)

  recipients ReminderRecipient[]
}

model ReminderRecipient {
  id            String      @id @default(cuid())
  reminderLogId String
  reminderLog   ReminderLog @relation(fields: [reminderLogId], references: [id])
  submitterId   String
  submitter     Submitter   @relation(fields: [submitterId], references: [submitterId])

  @@index([reminderLogId])
  @@index([submitterId])
}

// ============================================================================
// 이메일 템플릿 관리
// ============================================================================

// 저장된 이메일 템플릿 (재사용 가능)
// - SEND/SHARE 구분 없이 통일
model RemindTemplate {
  id           String   @id @default(cuid())
  name         String // 템플릿 이름
  greetingHtml String   @db.Text // 인사말 HTML
  footerHtml   String   @db.Text // 아랫말 HTML
  userId       String // 소유자
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
}

// 문서함별 템플릿 설정
// - 문서함별로 마지막 사용 템플릿 유지
// - 자동 리마인더도 이 템플릿을 사용
model DocumentBoxTemplateConfig {
  id            String      @id @default(cuid())
  documentBoxId String      @unique // 문서함당 1개
  documentBox   DocumentBox @relation(fields: [documentBoxId], references: [documentBoxId], onDelete: Cascade)

  // 마지막 사용 템플릿
  lastTemplateId   String? // 마지막으로 선택한 저장 템플릿 ID
  lastGreetingHtml String?  @db.Text // 인사말 HTML
  lastFooterHtml   String?  @db.Text // 아랫말 HTML

  updatedAt DateTime @updatedAt
}
